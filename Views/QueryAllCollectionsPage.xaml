<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="TA_WPF.Views.QueryAllCollectionsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:TA_WPF.Views"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:viewmodels="clr-namespace:TA_WPF.ViewModels"
             xmlns:system="clr-namespace:System;assembly=mscorlib"
             xmlns:converters="clr-namespace:TA_WPF.Converters"
             d:DataContext="{d:DesignInstance Type=viewmodels:QueryAllCollectionsViewModel}"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1300">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Defaults.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.DataGrid.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Button.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Shadows.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.ToggleButton.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.ComboBox.xaml" />
            </ResourceDictionary.MergedDictionaries>
            
            <!-- 添加全局字体大小资源 -->
            <system:Double x:Key="GlobalFontSize">12</system:Double>
            
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
            <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
            <converters:ByteArrayToImageConverter x:Key="ByteArrayToImageConverter" />
            
            <!-- 自定义转换器，判断byte[]是否非空 -->
            <converters:ObjectNotNullConverter x:Key="ObjectNotNullConverter" />
            
            <!-- 网格项样式 -->
            <Style x:Key="CollectionGridItemStyle" TargetType="Grid">
                <Setter Property="Margin" Value="8" />
                <Setter Property="Background" Value="{DynamicResource MaterialDesignPaper}" />
                <Setter Property="Effect">
                    <Setter.Value>
                        <DropShadowEffect ShadowDepth="2" BlurRadius="5" Direction="320" Opacity="0.3" />
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <!-- Light Mode Selected -->
                    <MultiDataTrigger>
                        <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding IsSelected}" Value="True" />
                            <Condition Binding="{Binding DataContext.MainViewModel.IsDarkMode, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="False" />
                        </MultiDataTrigger.Conditions>
                        <Setter Property="Effect">
                            <Setter.Value>
                                <DropShadowEffect ShadowDepth="3" BlurRadius="10" Direction="320" Opacity="0.5" Color="{DynamicResource Primary700}" />
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Background">
                            <Setter.Value>
                                <SolidColorBrush Color="{DynamicResource Primary50}" />
                            </Setter.Value>
                        </Setter>
                    </MultiDataTrigger>

                    <!-- Dark Mode Selected -->
                    <MultiDataTrigger>
                        <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding IsSelected}" Value="True" />
                            <Condition Binding="{Binding DataContext.MainViewModel.IsDarkMode, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True" />
                        </MultiDataTrigger.Conditions>
                        <Setter Property="Background">
                            <Setter.Value>
                                <SolidColorBrush Color="{Binding Source={StaticResource PrimaryHueMidBrush}, Path=Color}" Opacity="0.2" />
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Effect">
                            <Setter.Value>
                                <DropShadowEffect ShadowDepth="2" BlurRadius="8" Opacity="0.4" Color="{Binding Source={StaticResource MaterialDesignBody}, Path=Color}" />
                            </Setter.Value>
                        </Setter>
                    </MultiDataTrigger>

                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{DynamicResource MaterialDesignDivider}" />
                    </Trigger>
                </Style.Triggers>
            </Style>
            
            <!-- 数据表格单元格样式 -->
            <Style x:Key="DataGridCellStyle" TargetType="DataGridCell">
                <Setter Property="BorderThickness" Value="0" />
                <Setter Property="BorderBrush" Value="Transparent" />
                <Setter Property="Background" Value="Transparent" />
                <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                <Setter Property="Padding" Value="8,4" />
                <Setter Property="FontSize" Value="{Binding DataContext.MainViewModel.FontSize, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type DataGridCell}">
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    SnapsToDevicePixels="True">
                                <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                                VerticalAlignment="Center" 
                                                HorizontalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <Trigger Property="IsSelected" Value="True">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
            
            <!-- 数据表格文本列样式 -->
            <Style x:Key="DataGridTextColumnElementStyle" TargetType="TextBlock">
                <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}" />
                <Setter Property="VerticalAlignment" Value="Center" />
                <Setter Property="HorizontalAlignment" Value="Center" />
                <Setter Property="TextAlignment" Value="Center" />
                <Setter Property="TextWrapping" Value="NoWrap" />
                <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                <Setter Property="FontWeight" Value="Normal" />
                <Setter Property="FontSize" Value="{Binding DataContext.MainViewModel.FontSize, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                <Setter Property="Padding" Value="4,2" />
            </Style>
            
            <!-- 数据表格行样式 -->
            <Style x:Key="DataGridRowStyle" TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <Setter Property="BorderThickness" Value="0" />
                <Style.Triggers>
                    <Trigger Property="IsSelected" Value="True">
                        <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
                        <Setter Property="BorderThickness" Value="4,0,0,0" />
                        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueMidBrush}" />
                        <Setter Property="Foreground" Value="{DynamicResource PrimaryHueLightForegroundBrush}" />
                    </Trigger>
                    <Trigger Property="AlternationIndex" Value="1">
                        <Setter Property="Background" Value="{DynamicResource MaterialDesignDivider}" />
                    </Trigger>
                </Style.Triggers>
            </Style>
            
            <!-- 数据表格列头样式 -->
            <Style x:Key="DataGridColumnHeaderStyle" TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                <Setter Property="Background" Value="{DynamicResource PrimaryHueMidBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidForegroundBrush}" />
                <Setter Property="FontWeight" Value="Bold" />
                <Setter Property="HorizontalContentAlignment" Value="Center" />
                <Setter Property="Padding" Value="10,12" />
                <Setter Property="FontSize" Value="{Binding DataContext.MainViewModel.FontSize, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                <Setter Property="BorderThickness" Value="0,0,1,0" />
                <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueLightBrush}" />
                <Setter Property="Height" Value="40" />
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 操作栏 -->
        <Grid Grid.Row="0" Margin="10,10,10,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- 左侧按钮区域 -->
            <StackPanel Grid.Column="0" Orientation="Horizontal">
                <Button Command="{Binding AddCollectionCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="新建收藏夹"
                        Margin="0,0,8,0"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FolderPlus" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="新建" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding EditCollectionCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="修改收藏夹"
                        Margin="0,0,8,0"
                        IsEnabled="{Binding CanEditSelectedCollection}"
                        Visibility="{Binding HasSelection, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FolderEdit" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="修改" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding CopyCollectionCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="复制收藏夹"
                        Margin="0,0,8,0"
                        IsEnabled="{Binding CanEditSelectedCollection}"
                        Visibility="{Binding HasSelection, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="ContentCopy" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="复制" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding MoveCollectionCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="移动收藏夹"
                        Margin="0,0,8,0"
                        IsEnabled="{Binding HasSelection}"
                        Visibility="{Binding HasSelection, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="ContentCut" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="移动" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding DeleteCollectionCommand}" 
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        ToolTip="删除收藏夹"
                        Margin="0,0,8,0"
                        IsEnabled="{Binding HasSelection}"
                        Visibility="{Binding HasSelection, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Background="#F44336"
                        Foreground="White"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Delete" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="删除" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding SelectAllCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="全选"
                        Margin="0,0,8,0"
                        Visibility="{Binding HasData, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="CheckboxMultipleMarkedOutline" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="全选" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding InvertSelectionCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="反选"
                        Margin="0,0,8,0"
                        Visibility="{Binding HasData, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="CheckboxMultipleMarkedCircleOutline" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="反选" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding UnselectAllCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="取消选择"
                        Margin="0,0,8,0"
                        Visibility="{Binding HasData, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="CheckboxMultipleBlankOutline" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="取消选择" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="排序"
                        Margin="0,0,8,0"
                        Visibility="{Binding HasData, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36"
                        Click="SortButton_Click"
                        Name="SortButton">
                    <Button.Content>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Sort" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="排序" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button.Content>
                    <Button.ContextMenu>
                        <ContextMenu FontFamily="Microsoft YaHei">
                            <MenuItem Header="按车票数量排序" FontFamily="Microsoft YaHei">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="Ticket" />
                                </MenuItem.Icon>
                                <MenuItem Header="升序" Command="{Binding SortCollectionsCommand}" CommandParameter="TicketCount_Asc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortAscending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="降序" Command="{Binding SortCollectionsCommand}" CommandParameter="TicketCount_Desc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortDescending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                            </MenuItem>
                            <MenuItem Header="按修改日期排序" FontFamily="Microsoft YaHei">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="Update" />
                                </MenuItem.Icon>
                                <MenuItem Header="升序" Command="{Binding SortCollectionsCommand}" CommandParameter="UpdateTime_Asc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortAscending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="降序" Command="{Binding SortCollectionsCommand}" CommandParameter="UpdateTime_Desc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortDescending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                            </MenuItem>
                            <MenuItem Header="按创建时间排序" FontFamily="Microsoft YaHei">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="Creation" />
                                </MenuItem.Icon>
                                <MenuItem Header="升序" Command="{Binding SortCollectionsCommand}" CommandParameter="CreateTime_Asc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortAscending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="降序" Command="{Binding SortCollectionsCommand}" CommandParameter="CreateTime_Desc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortDescending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                            </MenuItem>
                            <MenuItem Header="按评分排序" FontFamily="Microsoft YaHei">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="Star" />
                                </MenuItem.Icon>
                                <MenuItem Header="升序" Command="{Binding SortCollectionsCommand}" CommandParameter="Importance_Asc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortAscending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="降序" Command="{Binding SortCollectionsCommand}" CommandParameter="Importance_Desc" FontFamily="Microsoft YaHei">
                                    <MenuItem.Icon>
                                        <materialDesign:PackIcon Kind="SortDescending" />
                                    </MenuItem.Icon>
                                </MenuItem>
                            </MenuItem>
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
            </StackPanel>

            <!-- 右侧视图切换按钮 -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Command="{Binding ToggleViewCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="列表视图"
                        Margin="0,0,8,0"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36"
                        Visibility="{Binding IsGridView, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="ViewList" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="列表" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding ToggleViewCommand}" 
                        Style="{StaticResource MaterialDesignFlatButton}"
                        ToolTip="网格视图"
                        Margin="0,0,8,0"
                        Foreground="{DynamicResource GlobalAccentBrush}"
                        Height="36"
                        Visibility="{Binding IsListView, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="ViewGrid" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="网格" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1" x:Name="QueryPanelContainer" Margin="10,10,10,0">
        </Grid>

        <!-- 数据显示区域 - Grid.Row=2 -->
        <Grid Grid.Row="2" Margin="10">
            <!-- 暂无数据提示 -->
            <TextBlock Text="暂无数据" 
                      HorizontalAlignment="Center" 
                      VerticalAlignment="Center"
                      Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                      Foreground="{DynamicResource MaterialDesignBodyLight}"
                      Visibility="{Binding HasNoData, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            
            <!-- 列表视图 - DataGrid -->
            <DataGrid ItemsSource="{Binding Collections}"
                     SelectedItem="{Binding SelectedCollection, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     CanUserAddRows="False"
                     CanUserDeleteRows="False"
                     IsReadOnly="True"
                     AutoGenerateColumns="False"
                     HeadersVisibility="Column"
                     SelectionMode="Extended"
                     SelectionUnit="FullRow"
                     EnableRowVirtualization="True"
                     EnableColumnVirtualization="True"
                     CanUserResizeRows="False"
                     CanUserResizeColumns="False"
                     CanUserSortColumns="False"
                     CanUserReorderColumns="False"
                     IsManipulationEnabled="True"
                     FontSize="{Binding MainViewModel.FontSize}"
                     RowHeight="{Binding DataGridRowHeight}"
                     materialDesign:DataGridAssist.CellPadding="12 6 12 6"
                     materialDesign:DataGridAssist.ColumnHeaderPadding="12 8 12 8"
                     HorizontalScrollBarVisibility="Auto"
                     VerticalScrollBarVisibility="Auto"
                     GridLinesVisibility="None"
                     HorizontalGridLinesBrush="{DynamicResource MaterialDesignDivider}"
                     VerticalGridLinesBrush="{DynamicResource MaterialDesignDivider}"
                     BorderThickness="0"
                     BorderBrush="{DynamicResource MaterialDesignDivider}"
                     Foreground="{DynamicResource MaterialDesignBody}"
                     AlternatingRowBackground="{DynamicResource MaterialDesignAlternatingRowBackground}"
                     Background="{DynamicResource MaterialDesignPaper}"
                     RowBackground="Transparent"
                     Margin="0"
                     Padding="0"
                     AlternationCount="2"
                     ColumnWidth="*"
                     Visibility="{Binding IsListView, Converter={StaticResource BooleanToVisibilityConverter}}"
                     MouseDoubleClick="DataGrid_MouseDoubleClick">
                <DataGrid.Resources>
                    <!-- 完全覆盖MaterialDesign默认的选中样式 -->
                    <SolidColorBrush x:Key="MaterialDesignSelection" Color="{DynamicResource Primary700}" Opacity="0.1" />
                    
                    <!-- 重写单元格样式 -->
                    <Style x:Key="DataGridRowStyle" TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        <Setter Property="BorderThickness" Value="0" />
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
                                <Setter Property="BorderThickness" Value="4,0,0,0" />
                                <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueMidBrush}" />
                                <Setter Property="Foreground" Value="{DynamicResource PrimaryHueLightForegroundBrush}" />
                            </Trigger>
                            <Trigger Property="AlternationIndex" Value="1">
                                <Setter Property="Background" Value="{DynamicResource MaterialDesignDivider}" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                    
                    <Style x:Key="DataGridCellStyle" TargetType="DataGridCell">
                        <Setter Property="BorderThickness" Value="0" />
                        <Setter Property="BorderBrush" Value="Transparent" />
                        <Setter Property="Background" Value="Transparent" />
                        <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                        <Setter Property="Padding" Value="8,4" />
                        <Setter Property="FontSize" Value="{Binding DataContext.MainViewModel.FontSize, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type DataGridCell}">
                                    <Border Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            SnapsToDevicePixels="True">
                                        <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                                        VerticalAlignment="Center"
                                                        HorizontalAlignment="Center"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}"/>
                                <Setter Property="BorderBrush" Value="Transparent"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                    
                    <Style x:Key="DataGridColumnHeaderStyle" TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                        <Setter Property="Background" Value="{DynamicResource PrimaryHueMidBrush}" />
                        <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidForegroundBrush}" />
                        <Setter Property="FontWeight" Value="Bold" />
                        <Setter Property="HorizontalContentAlignment" Value="Center" />
                        <Setter Property="Padding" Value="10,12" />
                        <Setter Property="FontSize" Value="{Binding DataContext.MainViewModel.FontSize, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                        <Setter Property="BorderThickness" Value="0,0,1,0" />
                        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueLightBrush}" />
                        <Setter Property="Height" Value="{Binding DataContext.DataGridRowHeight, RelativeSource={RelativeSource AncestorType=DataGrid}}" />
                    </Style>
                </DataGrid.Resources>
                
                <!-- 数据表格样式 -->
                <DataGrid.RowStyle>
                    <StaticResource ResourceKey="DataGridRowStyle"/>
                </DataGrid.RowStyle>
                <DataGrid.CellStyle>
                    <StaticResource ResourceKey="DataGridCellStyle"/>
                </DataGrid.CellStyle>
                <DataGrid.ColumnHeaderStyle>
                    <StaticResource ResourceKey="DataGridColumnHeaderStyle"/>
                </DataGrid.ColumnHeaderStyle>
                
                <DataGrid.Columns>
                    <!-- ID Column - 隐藏 -->
                    <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="0" IsReadOnly="True" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}" Visibility="Collapsed"/>
                    
                    <!-- 收藏夹名称 Column -->
                    <DataGridTextColumn Header="收藏夹名称" Binding="{Binding CollectionName}" Width="3*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                    
                    <!-- 描述 Column -->
                    <DataGridTextColumn Header="描述" Binding="{Binding Description}" Width="4*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                    
                    <!-- 车票数量 Column -->
                    <DataGridTextColumn Header="包含车票数量" Binding="{Binding TicketCount}" Width="1*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                    
                    <!-- 创建时间 Column -->
                    <DataGridTextColumn Header="创建时间" Binding="{Binding CreateTime, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="2*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                    
                    <!-- 更新时间 Column -->
                    <DataGridTextColumn Header="更新时间" Binding="{Binding UpdateTime, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="2*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                    
                    <!-- 排序顺序 Column -->
                    <DataGridTextColumn Header="排序顺序" Binding="{Binding SortOrder}" Width="1*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                    
                    <!-- 评分 Column -->
                    <DataGridTextColumn Header="评分" Binding="{Binding Importance}" Width="1*" 
                                        ElementStyle="{StaticResource DataGridTextColumnElementStyle}"/>
                </DataGrid.Columns>
            </DataGrid>
            
            <!-- 网格视图 -->
            <ListBox ItemsSource="{Binding Collections}"
                     SelectedItem="{Binding SelectedCollection, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     SelectionMode="Extended"
                     Background="Transparent"
                     BorderThickness="0"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     Visibility="{Binding IsGridView, Converter={StaticResource BooleanToVisibilityConverter}}"
                     Margin="0"
                     MouseDoubleClick="ListBox_MouseDoubleClick"
                     AllowDrop="True"
                     PreviewMouseLeftButtonDown="ListBox_PreviewMouseLeftButtonDown"
                     PreviewMouseMove="ListBox_PreviewMouseMove"
                     PreviewDragOver="ListBox_PreviewDragOver"
                     Drop="ListBox_Drop">
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="VerticalContentAlignment" Value="Stretch"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <ContentPresenter/>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid Width="200" Height="250" Style="{StaticResource CollectionGridItemStyle}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="40" />
                                <RowDefinition Height="100" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- 收藏夹标题栏 -->
                            <Border Grid.Row="0" Background="{DynamicResource PrimaryHueMidBrush}">
                                <TextBlock Text="{Binding CollectionName}" 
                                           Foreground="{DynamicResource PrimaryHueMidForegroundBrush}"
                                           FontWeight="Bold"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"
                                           Margin="6"
                                           TextWrapping="NoWrap"
                                           TextTrimming="CharacterEllipsis" />
                            </Border>

                            <!-- 收藏夹封面图片 -->
                            <Border Grid.Row="1" Background="White" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource MaterialDesignDivider}">
                                <Grid>
                                    <!-- 默认图标或文字，当没有图片时显示 -->
                                    <TextBlock Text="图片" 
                                              Foreground="Black" 
                                              FontSize="24" 
                                              FontWeight="Bold"
                                              HorizontalAlignment="Center" 
                                              VerticalAlignment="Center"
                                              Visibility="{Binding CoverImage, Converter={StaticResource ObjectNotNullConverter}, ConverterParameter=inverse}"/>
                                    
                                    <!-- 实际封面图片 -->
                                    <Image Stretch="UniformToFill" 
                                           Margin="0"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           Width="200"
                                           Height="100"
                                           Source="{Binding CoverImage, Converter={StaticResource ByteArrayToImageConverter}}"
                                           Visibility="{Binding CoverImage, Converter={StaticResource ObjectNotNullConverter}}"/>
                                </Grid>
                            </Border>

                            <!-- 车票数量信息 -->
                            <StackPanel Grid.Row="2" 
                                        Orientation="Horizontal" 
                                        HorizontalAlignment="Center"
                                        Background="{DynamicResource MaterialDesignPaper}"
                                        Margin="0,4">
                                <materialDesign:PackIcon Kind="Ticket" 
                                                         VerticalAlignment="Center" 
                                                         Foreground="{DynamicResource PrimaryHueMidBrush}"
                                                         Margin="0,0,4,0"/>
                                <TextBlock Text="{Binding TicketCount}" 
                                           VerticalAlignment="Center"
                                           FontWeight="SemiBold"/>
                                <TextBlock Text=" 张车票" 
                                           VerticalAlignment="Center"
                                           Margin="2,0,0,0"/>
                            </StackPanel>

                            <!-- 收藏夹描述 -->
                            <TextBlock Grid.Row="3" 
                                       Text="{Binding Description}" 
                                       Style="{StaticResource MaterialDesignBody2TextBlock}" 
                                       Margin="8,4,8,8" 
                                       TextWrapping="Wrap"
                                       TextTrimming="CharacterEllipsis"
                                       MaxHeight="54"
                                       VerticalAlignment="Top"/>

                            <!-- 鼠标悬停时显示的额外信息 -->
                            <Border Grid.Row="0" Grid.RowSpan="4" 
                                    Background="#CC000000" 
                                    Visibility="Collapsed"
                                    Panel.ZIndex="1"
                                    x:Name="HoverInfoPanel">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="230" Focusable="False">
                                    <StackPanel VerticalAlignment="Top" Margin="10">
                                        <TextBlock Text="{Binding CollectionName}" 
                                                   Foreground="White" 
                                                   FontWeight="Bold" 
                                                   Style="{StaticResource MaterialDesignSubtitle1TextBlock}" 
                                                   Margin="0,0,0,8"
                                                   TextWrapping="Wrap"/>
                                        
                                        <TextBlock Foreground="White" Margin="0,2" TextWrapping="Wrap" TextTrimming="CharacterEllipsis" MaxHeight="54">
                                            <Run Text="描述: "/>
                                            <Run Text="{Binding Description}"/>
                                        </TextBlock>
                                        
                                        <TextBlock Foreground="White" Margin="0,2" TextWrapping="Wrap">
                                            <Run Text="包含车票数量: "/>
                                            <Run Text="{Binding TicketCount}"/>
                                        </TextBlock>
                                        
                                        <TextBlock Foreground="White" Margin="0,2" TextWrapping="Wrap">
                                            <Run Text="创建时间: "/>
                                            <Run Text="{Binding CreateTime, StringFormat=yyyy-MM-dd}"/>
                                        </TextBlock>
                                        
                                        <TextBlock Foreground="White" Margin="0,2" TextWrapping="Wrap">
                                            <Run Text="修改时间: "/>
                                            <Run Text="{Binding UpdateTime, StringFormat=yyyy-MM-dd}"/>
                                        </TextBlock>
                                        
                                        <TextBlock Foreground="White" Margin="0,2" TextWrapping="Wrap">
                                            <Run Text="评分: "/>
                                            <Run Text="{Binding Importance}"/>
                                            <Run Text=" 星"/>
                                        </TextBlock>
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>
                        </Grid>
                        <DataTemplate.Triggers>
                            <EventTrigger RoutedEvent="Mouse.MouseEnter">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="HoverInfoPanel" 
                                                                       Storyboard.TargetProperty="(UIElement.Visibility)">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Visible}"/>
                                        </ObjectAnimationUsingKeyFrames>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                            <EventTrigger RoutedEvent="Mouse.MouseLeave">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="HoverInfoPanel" 
                                                                       Storyboard.TargetProperty="(UIElement.Visibility)">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{x:Static Visibility.Collapsed}"/>
                                        </ObjectAnimationUsingKeyFrames>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>
        
        <!-- 分页控件 - Grid.Row=3 -->
        <Grid Grid.Row="3" Margin="10,0,10,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧：页大小选择 -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="每页显示:" 
                           Style="{StaticResource MaterialDesignBody1TextBlock}" 
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"/>
                <ComboBox ItemsSource="{Binding PaginationViewModel.PageSizeOptions}"
                          SelectedItem="{Binding PaginationViewModel.PageSize}"
                          Width="60"
                          materialDesign:HintAssist.Hint="页大小"
                          Style="{StaticResource MaterialDesignComboBox}"/>
                
                <!-- 总记录数和选中项数量 -->
                <TextBlock Text="{Binding TotalCount, StringFormat=总记录数: {0}}" 
                           Style="{StaticResource MaterialDesignBody1TextBlock}" 
                           VerticalAlignment="Center"
                           Margin="16,0,0,0"/>
                
                <!-- 选择状态指示器 -->
                <TextBlock Text="{Binding SelectedItemsCount, StringFormat=已选择 {0} 项}"
                           Style="{StaticResource MaterialDesignBody1TextBlock}" 
                           VerticalAlignment="Center"
                           Margin="16,0,0,0"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           FontWeight="Medium"
                           Visibility="{Binding HasSelection, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>

            <!-- 右侧：分页导航 -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal" Margin="0,0,0,0">
                    <Button Command="{Binding PaginationViewModel.FirstPageCommand}" 
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="第一页"
                            Margin="0,0,4,0"
                            Foreground="{DynamicResource GlobalAccentBrush}"
                            IsEnabled="{Binding PaginationViewModel.CanNavigateToFirstPage}">
                        <materialDesign:PackIcon Kind="PageFirst" />
                    </Button>
                    <Button Command="{Binding PaginationViewModel.PreviousPageCommand}" 
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="上一页"
                            Margin="0,0,4,0"
                            Foreground="{DynamicResource GlobalAccentBrush}"
                            IsEnabled="{Binding PaginationViewModel.CanNavigateToPreviousPage}">
                        <materialDesign:PackIcon Kind="ChevronLeft" />
                    </Button>
                    <Border Background="{DynamicResource MaterialDesignPaper}" 
                            BorderBrush="{DynamicResource GlobalAccentBrush}" 
                            BorderThickness="1" 
                            CornerRadius="4"
                            Padding="8,4"
                            Margin="4,0"
                            Height="36">
                        <StackPanel Orientation="Horizontal" x:Name="PageInfoPanel" MouseLeftButtonDown="PageInfoPanel_MouseLeftButtonDown">
                            <TextBlock Text="{Binding PaginationViewModel.CurrentPage}" 
                                       Style="{StaticResource MaterialDesignBody1TextBlock}"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource GlobalAccentBrush}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text=" / " 
                                       Style="{StaticResource MaterialDesignBody1TextBlock}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding PaginationViewModel.TotalPages}" 
                                       Style="{StaticResource MaterialDesignBody1TextBlock}"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                    <TextBox x:Name="PageNumberInput"
                             Width="60"
                             Height="36"
                             Margin="4,0"
                             Style="{StaticResource MaterialDesignTextBox}"
                             materialDesign:HintAssist.Hint="页码"
                             VerticalAlignment="Center"
                             HorizontalContentAlignment="Center"
                             VerticalContentAlignment="Center"
                             Visibility="Collapsed"
                             KeyDown="PageNumberInput_KeyDown"
                             LostFocus="PageNumberInput_LostFocus"/>
                    <Button Command="{Binding PaginationViewModel.NextPageCommand}" 
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="下一页"
                            Margin="4,0,0,0"
                            Foreground="{DynamicResource GlobalAccentBrush}"
                            IsEnabled="{Binding PaginationViewModel.CanNavigateToNextPage}">
                        <materialDesign:PackIcon Kind="ChevronRight" />
                    </Button>
                    <Button Command="{Binding PaginationViewModel.LastPageCommand}" 
                            Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="最后一页"
                            Margin="4,0,0,0"
                            Foreground="{DynamicResource GlobalAccentBrush}"
                            IsEnabled="{Binding PaginationViewModel.CanNavigateToLastPage}">
                        <materialDesign:PackIcon Kind="PageLast" />
                    </Button>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- 加载指示器 -->
        <Grid Grid.Row="0" Grid.RowSpan="4" 
              Background="#80000000" 
              Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" 
                             Value="0" 
                             IsIndeterminate="True" 
                             Width="48" 
                             Height="48"
                             Margin="0,0,0,8"/>
                <TextBlock Text="加载中" 
                           Style="{StaticResource MaterialDesignBody1TextBlock}"
                           HorizontalAlignment="Center"
                           Foreground="White"
                           FontWeight="Medium"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl> 